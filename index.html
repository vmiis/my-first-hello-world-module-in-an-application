<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Modular distributed web application</title>
		<meta charset="utf-8">
		<meta name='viewport' content='width=device-width, initial-scale=1'>
		<script src="https://ajax.aspnetcdn.com/ajax/jquery/jquery-3.2.1.min.js"></script>
        <script>
			$.ajaxSetup({cache:true});
			$vm={};$VmAPI={};$vm.module_list={};
			//--------------------------------------------------------
			//get hosting path
			var href = window.location.href.split('?')[0];
			var path=href.split('/index.html')[0];
			var lastChar=path[path.length-1];
			if(lastChar=='/') path=path.substring(0,path.length-1);
			$vm.hosting_path=path;
			//--------------------------------------------------------
			$vm.ver=["1","1","1"]
			$vm.version=$vm.ver[0];
			//--------------------------------------------------------
			var load_config_and_init=function(){
				var url=$vm.hosting_path+"/index.json";
				var ver=localStorage.getItem(url+"_ver");
				var txt=localStorage.getItem(url+"_txt");
				//------------------------------------------
				if(ver!=$vm.ver[1] || txt===null || $vm.debug===true || $vm.reload!=''){
					$.get(url+'?_='+$vm.ver[1]+$vm.reload,function(data){
						localStorage.setItem(url+"_txt",data);
						localStorage.setItem(url+"_ver",$vm.ver[1]);
						app_init(data);;
					},'text').fail(function() {
						alert( "The configuration file ("+url+") doesn't exist!" );
					});
				}
				else{ app_init(txt); }
				//------------------------------------------
			}
			//--------------------------------------------------------
			var app_init=function(txt){
				var config;	try{ config=JSON.parse(txt);}
				catch (e){ alert("Error in app config file\n"+e); return; }
				$vm.app_config=config;
				$vm.server          ='development';
				$VmAPI.api_base     =config.api_path_development;
				load_vmapi();
			}
			//--------------------------------------------------------
			var load_vmapi   =function(){ load_js($vm.url('https://vmiis.github.io/api/distribution/vmapi.min.js'),load_vm);	}
			var load_vm      =function(){ load_js($vm.url('https://vmiis.github.io/framework/distribution/vmframework.min.js'),init);}
			var init         =function(){
				$vm.init_v3({callback:function(){$vm.init_status=1;}})
				$vm.load_first_module_to_body({url:'/layout.html',callback:last});
			}
			//--------------------------------------------------------
			var load_js=function(url,next){
		        //this is js loader
				var ver=localStorage.getItem(url+"_ver");
				var txt=localStorage.getItem(url+"_txt");
				//------------------------------------------
				if(ver!=$vm.ver[2] || txt===null || $vm.debug===true || $vm.reload!=''){
					$.get(url+'?_='+$vm.ver[2]+$vm.reload,function(data){
						localStorage.setItem(url+"_txt",data);
						localStorage.setItem(url+"_ver",$vm.ver[2]);
						$('head').append('<scr'+'ipt>'+data+'</scr'+'ipt>');
						next();
					},'text');
				}
				else{ $('head').append('<scr'+'ipt>'+txt+'</scr'+'ipt>'); next(); }
				//------------------------------------------
			}
			//--------------------------------------------------------
			$vm.url=function(text){
				text=text.replace(/__HOST__\//g,$vm.hosting_path+'/');
				text=text.replace(/__VER__/g,$vm.ver[0]);
		        text=text.replace(/__COMPONENT__\//g,'https://vmiis.github.io/component/');
				text=text.replace(/https:\/\/vmiis.github.io\/modular-distributed-web-application\//g,'https://www.vmiis.com/');
				return text;
			}
			//--------------------------------------------------------
			var last=function(){
		        //run all following code at last so as to make the first module to be seen as soon as possible
				$('head').append("<link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css'>");
		        $('head').append("<link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css'>");
				$('head').append("<link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.7.1/css/bootstrap-datepicker.standalone.css'>");
		        $('head').append("<link rel='stylesheet' href='https://ajax.aspnetcdn.com/ajax/jquery.ui/1.12.1/themes/redmond/jquery-ui.css'>");
				$.getScript('https://cdnjs.cloudflare.com/ajax/libs/particlesjs/2.0.2/particles.min.js',function(){$vm.js_particlesjs=1;});
		        $.getScript('https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js');
		        $.getScript('https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js',function(){$vm.js_bootstrap=1;});
				$.getScript('https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.7.1/js/bootstrap-datepicker.min.js');
				$.getScript('https://ajax.aspnetcdn.com/ajax/jquery.ui/1.12.1/jquery-ui.min.js',function(){$vm.js_jquery_ui=1;});
				$.getScript('https://apis.google.com/js/plusone.js');
			}
			//********************************************************
			load_config_and_init();
			//********************************************************
		</script>
	</head>
	<body></body>
</html>
